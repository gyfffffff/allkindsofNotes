## Stock Movement Prediction from Tweets and Historical Prices

[toc]



### 摘要

股票波动预测是一个具有挑战性的问题：股市**高度随机**，我们从**混沌**的数据中做**时序预测**。

我们将这些三种复杂性纳入考虑，并提出了一种新颖的深度生成模型，该模型同时利用文本和价格信号来进行预测。

与判别模型或主题建模不同，我们的模型引入了**经常性的连续潜变量**，以更好地处理随机性。

此外，我们的模型还使用**神经变分推断**来解决难以计算的**后验推断**问题。

我们还提供了一个混合目标函数，结合了**时间辅助信息**，以灵活地捕捉预测之间的依赖关系。

| 变量名     | 含义       |
| ---------- | ---------- |
| s          | 目标股票   |
| d          | 目标交易日 |
| $\delta d$ | lag        |
|            |            |
|            |            |
|            |            |



### 问题定义

目标：预测某支股票s在某个交易日d的的波动。

我们使用包含相关社交媒体语料库（如推特）以及历史价格$[d-\delta d, d-1]$的市场信息。$\delta d$固定。

我们评估二进制的波动，1代表升，0代表降。

![image-20230706122715225](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706122715225.png)

$p_d^c$ 表示调整后的收盘价格，该价格经过**调整以反映影响股票价格的企业行动**，例如股息和拆分。调整后的收盘价在预测股票价格波动和金融波动中有广泛应用。

d-1可能不是有效交易日，因此没有可用的价格信息。在本文剩余部分，这个问题被解决了，方法是我们的**循环模型保持符号一致性**并使用其时间步长t来索引交易日。

### 数据收集

股票分九种：基本材料、消费品、医疗保健、服务、公用事业、企业集团、金融、工业品和技术。

因为高交易量股票在推特上讨论更多，我们选择了两年的价格波动。从2014.1.1-2016.1.1, 88支股票，其中包括企业集团行业的所有8支股票，以及其他八个行业中按市值排名前十的股票（具体信息请参考附加资料）。

我们观察到，我们观察到有一些目标股票的价格变动比率异常微小。

删除了38.72%的股票，这些股票的波动在(-0.5%,  0.55%]之间。小于0.5的，标记为0，大于0.55的，标记为1。

阈值的选择是为了平衡两类。26614个预测目标，49.78%负类，50.22%正类。我们按时间将它们进行了分割，其中

20,339个股票价格变动数据是用于训练的，时间范围为2014年1月1日至2015年1月8日；

2,555个股票价格变动数据是用于**开发**的，时间范围为2015年1月8日至2015年1月10日；

3,720个股票价格变动数据是用于测试的，时间范围为2015年1月10日至2016年1月1日。

数据集的两个主要组成部分：推特数据集+历史价格数据集

我们在遵守Twitter的官方许可下访问Twitter数据，然后通过查询由**NASDAQ股票代码**组成的正则表达式来检索特定股票的相关推文，例如使用"$GOOG\b"查询谷歌公司（Google Inc）的相关推文。

使用有特定推特模式的NLTK包处理推特文本，包含了超链接、hashtag和@符合的处理。为了减轻**稀疏性**，通过确保每个$\delta d$中至少有一个推文来对样本进行过滤。

我们从雅虎金融中抽取88支选定的股票的历史价格，来构建历史价格数据集。

### 模型概览

从观察到的市场信息到股票波动的生成过程的描述。



我们提供**数据对齐**、模型分解和模型组件的概述。

我们假设交易日d的波动可以受益于预测其之前交易日的股票价格变动。然而，由于样本独立性的一般原则，**直接在训练模型时建立与时间上接近的目标日期的样本之间的连接是有问题的。**

作为替代，我们注意到在一个包含目标交易日d的样本中，**其时间滞后中可能存在其他与d不同的交易日**，这些交易日可以模拟接近d的预测目标。

受这个观察和多任务学习的启发，我们不仅对d预测，而且对其他在Lag中的交易日都做预测。

例如，如图二所示，socketNet的结构。我们用主要目标8/7和lag大小5做描述。8/4-8/5是周末，交易日对齐帮助stocknet对其他三天组织信息语料和历史价格。我们使用虚线表示帮助部分。红点表示时间目标用时间注意力机制整合，以获取最后训练目标。

![image-20230706202112571](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706202112571.png)

对于样本2012/8/7和5天的lag，2012/8/3 - 2012/8/6是lag中的交易日。我们也对他们用这个样本中的市场信息做预测。这些预测之间的关系可以在一个样本的范围内捕捉到。

不是lag中每天都是有效交易日，会有周末，节假日。为了更好组织和使用输入，我们考虑交易日，而不是日历日，作为基本单元来构建样本。我们首先找到样本中所有T个有效交易日，也就是<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706203900245.png" alt="image-20230706203900245" style="zoom:50%;" />.

为了清晰起见，在一个样本的范围内，我们使用t ∈ [1, T]来索引这些交易日，并且每个交易日都映射到一个实际的（绝对）交易日dt。然后，我们提出了交易日对齐的方法：我们重新组织我们的输入数据，包括推文语料库和历史价格，通过将它们与这T个交易日进行对齐。具体而言，在第t个交易日，我们从时间范围[dt−1, dt)的语料库Mt中识别市场信号，并使用dt−1日的历史价格pt来预测dt日的股票价格变动yt。

我们在图2中提供了一个对齐的样本作为示例。因此，样本中的每个单元都是一个交易日，我们可以预测一个股票价格变动序列y = [y1, . . . , yT]。主要目标是yT，而剩余部分y∗ = [y1, . . . , yT −1]作为时间辅助目标。我们将这些辅助目标与主要目标一起使用，以提高预测的准确性。



生成过程建模：

实线表示生成过程，虚线表示**对难以计算的后验进行变分近似**。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706200052109.png" alt="image-20230706200052109" style="zoom: 80%;" />

将观察到的市场信息编码成随机变量<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706205117984.png" alt="image-20230706205117984" style="zoom:50%;" />, 从中我们生成隐驱动因子Z = <img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706205210864.png" alt="image-20230706205210864" style="zoom:50%;" />。为了实现前面提到的多任务学习目标，我们的目标是对条件概率分布进行建模，即pθ(y|X) = $\int_Z pθ(y, Z|X)$，而不是pθ(yT |X)。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706205644759.png" alt="image-20230706205644759" style="zoom:67%;" />

由于在生成过程中y∗是已知的，我们使用后验概率pθ (zt |z<t, x≤t, yt)，其中t < T，更准确地融入市场信号，并且在生成zT时只使用先验概率pθ(zT |z<T , X)。此外，当t < T时，yt与z<t是独立的，而我们的主要预测目标yT通过时间注意机制（第5.3节）与z<T相关联。

socketnet由三个主要部分组成：

1. MIE：股票信息编码，编码推特和价格到X
2. VMD：变分运动解码器（VMD）通过X、y推断Z，并通过X、Z解码股票价格变动y。
3. ATA：注意力时序辅助（ATA）通过注意力机制集成时间损失，用于模型训练。

### 模型组件

#### MIE

MIE（Market Information Encoder）将社交媒体和股票价格的信息进行编码，以提高市场信息的质量，并输出用于VMD的市场信息输入X。每个时序输入被定义为xt = [ct, pt]，其中ct是语料库嵌入（corpus embedding），pt是历史价格向量（historical price vector）。

获取ct的基本策略是首先将消息输入到消息嵌入层中进行低维表示，然后根据其质量有选择地收集它们。为了处理在单个消息中讨论多个股票的情况，除了文本信息外，我们还将消息中提到的**股票符号的位置信息**纳入考虑。

具体而言，该层包含一个前向GRU和一个后向GRU，分别用于处理股票符号s的前文和后文。在第t个交易日的消息语料库中，我们将第k条消息（k ∈ [1, K]）的词序列表示为W，其中W`? = s，`? ∈ [1, L]，并将其词嵌入矩阵表示为E = [e1; e2; . . . ; eL]。

![image-20230706213201188](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706213201188.png)

![image-20230706213326998](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706213326998.png)

股票符号被视为前文和后文中的最后一个单元，在这两个上下文中，隐藏状态值−→hl?和←−hl?被平均以获得消息嵌入m。

将第t个交易日的所有消息嵌入聚集起来，我们得到一个消息嵌入矩阵Mt ∈ R^(dm×K)。在实际应用中，该层以一个五阶张量（五维数组）作为小批量输入，使用共享参数生成批量中的所有Mt。

推文的质量存在很大的差异。受到新闻级别注意力（Hu等人，2018年）的启发，我们根据它们在**集体智能度量**中的重要性给消息赋予权重。具体而言，我们首先将Mt非线性投影到ut，即语料库中归一化的注意力权重，

![image-20230707101627792](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707101627792.png)

然后根据权重压缩信息

![image-20230707102057846](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707102057846.png)

由于股票的走势是由价格变动而不是绝对价格值决定的，因此我们在将原始价格向量<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707102301242.png" alt="image-20230707102301242" style="zoom:67%;" />（包括交易日t的调整收盘价、最高价和最低价)直接输入网络之前，通过其最后一个调整收盘价进行归一化，即<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707102324219.png" alt="image-20230707102324219" style="zoom:67%;" />。然后，我们将ct与pt连接起来形成解码器的最终市场信息输入xt。

问题：

h如何初始化？

#### VMD

VMD的目的是通过对编码的市场信息X进行循环推断和解码，从中推断出潜在的驱动因素Z和股票的走势y。

推断

尽管潜在驱动因素有助于描述导致股票走势的市场状况，但在生成模型中，如公式（2）所示的后验推断（潜变量的分布）是难以处理的。遵循VAE（将自动编码器和变分推断结合起来，以实现对数据分布的建模和生成）的思想，我们使用深度神经网络来拟合潜在分布，即先验分布pθ(zt|z<t, x≤t)和后验分布pθ(zt|z<t, x≤t, yt)，通过**神经逼近和重参数化**（Kingma和Welling，2013；Rezende等，2014）来避免难以处理的问题。我们首先使用**变分近似器**qφ(zt|z<t, x≤t, yt)来近似难以处理的后验分布。我们观察到以下因子分解情况，

![image-20230707105742341](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707105742341.png)

神经逼近的目标是最小化qφ(Z|X, y)和pθ(Z|X, y)之间的Kullback-Leibler散度。我们观察到以下自然成立的方程式，而不是直接优化它，

![image-20230707105859331](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707105859331.png)

因此，我们通过将公式（2、9）代入公式（10），等价地最大化以下变分循环下界：

![image-20230707110414692](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707110414692.png)

似然项（给定先前观测数据和隐藏状态的情况下，当前观测数据的条件概率)：

![image-20230707110456238](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707110456238.png)

Li等人（2017）还提供了一个推断文本摘要中直接连接的递归潜变量的下界。在他们的工作中，先验被建模为pθ(zt) ∼ N(0, I)，这实际上将KL项转化为一个静态的正则化项，促进了稀疏性。在公式（11）中，我们提供了一个更具理论严密性的下界，其中KL项pθ(zt|z<t, x≤t)在推断每个不同的模型输入和潜在历史的相关潜变量时发挥动态作用。

解码

对于时间序列数据，VMD采用了一个带有GRU单元的RNN来循环地提取特征并解码股票信号。

![image-20230707112152921](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707112152921.png)

我们让近似器qφ(zt|z<t, x≤t, yt)服从标准多元高斯分布N(µ, δ^2I)。我们计算µ和δ的方式如下：

![image-20230707112244853](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707112244853.png)

共享的隐表示：

![image-20230707112355252](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707112355252.png)

由于高斯分布属于“位置-尺度”分布家族，我们可以进一步对zt进行重新参数化，如下所示：

![image-20230707112737563](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230707112737563.png)

![image-20230709222921893](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230709222921893.png)

类似地，我们让先验分布 pθ (zt |z<t, x≤t) 近似为 N (µ0, δ02I)。它的计算与后验分布相同，只是没有yt和独立的模型参数。

![image-20230709223117022](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230709223117022.png)

根据文中提到的参考文献 Zhang et al. (2016)，与后验分布不同的是，在解码过程中我们将先验分布的zt设置为µ0t。最终，我们整合确定性特征，得到最终的预测假设。

![image-20230709223706254](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230709223706254.png)

在上述论文中提到，Wg和Wy是权重矩阵，bg和by是偏置项。Softmax函数ζ(·)用于输出上涨和下跌的置信度分布。正如在第4节中介绍的，主要目标yT的解码取决于z<T，因此处于VMD和ATA之间的接口位置。在下一节中，我们将对此进行详细阐述。

#### ATA

通过获取一系列辅助预测Y˜∗ = [˜y1; . . . ; ˜yT −1]，我们首先引入了一个共享的时间注意力机制，将两种辅助效果灵活地整合到主要预测和训练目标中。

由于每个时间辅助假设对主要预测和模型训练的贡献不均，如图3所示，因此时间注意力通过使用两个评分组件（信息评分和依赖评分）计算它们在这两个贡献中的权重。具体地说，

![image-20230710094446395](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710094446395.png)



综合表示G∗ = [g1; . . . ; gT −1]和gT被重新用作时间市场信息的最终表示。信息评分vi根据历史交易日的信息质量进行评估，而依赖评分vd则捕捉它们与主要目标的依赖关系。我们将这两者整合起来，并通过将它们的逐元素乘积输入到softmax函数中，获得最终的归一化注意力权重v ∗ ∈ R 1×(T −1)。

因此，主要预测可以从已经做出的**时间上接近的假设**中受益，并且我们将我们的主要假设解码为y˜T。

![image-20230710095531541](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710095531541.png)

至于模型目标，我们使用蒙特卡洛方法来近似公式（11）中的期望项，通常只使用一个样本进行梯度计算。为了在目标层面上考虑不同的时间重要性，我们首先将近似的L分解为一系列时间目标f ∈ RT ×1，其中ft包括交易日t的似然项和KL项。

![image-20230710100022738](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710100022738.png)

在模型的训练过程中，我们采用了**KL项退火技巧**（Bowman et al., 2016; Semeniuta et al., 2017），并添加了一个线性递增的KL项权重λ ∈ (0, 1]，以逐渐释放KL正则化效果。然后，我们重新使用v∗来构建最终的时间权重向量v ∈ R1×T。

![image-20230710100727242](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710100727242.png)

其中1表示主要预测，我们采用辅助权重α ∈ [0, 1]来控制辅助效果对模型训练的整体影响。α的调整是在开发集上进行的，并且其效果将在第6.5节中详细讨论。最后，我们通过重新组合来编写训练目标F。

![image-20230710100853857](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710100853857.png)

通过选择性地关注时间辅助信息，我们的模型可以学习泛化。我们通过反向传播计算F对所有模型参数{θ, φ}的导数，以进行更新。



### 实验

#### 训练设定

5天的滞后窗口进行样本构建，每个**批次**包含32个打乱的样本。

每条消息中包含的最大token数和每个交易日上的最大消息数分别经验性地设置为30和40，超出部分被截断。

由于批量样本中的所有推文同时被输入模型，我们将词嵌入大小设置为50，而不是更大的大小，以控制内存成本，并使模型训练在单个GPU上可行（11GB内存）。

我们将消息嵌入层的隐藏大小设置为100，将VMD的隐藏大小设置为150。模型中的所有权重矩阵均使用**扇入技巧**（权重矩阵的初始化取决于其输入连接的数量）进行初始化，偏置项初始化为零。

我们使用Adam优化器（Kingma和Ba，2014）进行模型训练，初始学习率为0.001。按照Bowman等人（2016）的做法，我们使用了输入的dropout率为0.3来对潜在变量进行正则化。我们使用Tensorflow（Abadi等人，2016）构建了StockNet的**计算图**，并在开发集上调整了超参数。

#### 评估方法

给定混淆矩阵：

![image-20230710103213684](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710103213684.png)

##### baseline

RAND：一种简单的随机猜测模型，随机选择上涨或下跌。
ARIMA：自回归移动平均模型，一种基于价格信号的高级技术分析方法。
RANDFOREST：使用Word2vec文本表示的判别性随机森林分类器。
TSLDA：一种生成式主题模型，同时学习主题和情感信息。
HAN：一种先进的判别性深度神经网络模型，具有分层注意力机制。

为了对StockNet中的所有主要组成部分进行详细分析，除了完整配置的HEDGEFUNDANALYST模型（完整的StockNet模型）之外，我们还构建了以下四个变体：

- TECHNICALANALYST：仅使用历史价格信息的生成式StockNet模型。
- FUNDAMENTALANALYST：仅使用推文信息的生成式StockNet模型。
- INDEPENDENTANALYST：不使用时间辅助目标的生成式StockNet模型。
- DISCRIMINATIVEANALYST：直接优化似然目标的判别式StockNet模型。按照Zhang等人（2016）的方法，我们设置zt = µ0t以消除KL项的影响。

通过构建这些不同的变体模型，我们可以对StockNet的各个组成部分进行详细分析和评估。这些模型将帮助我们了解各个组件在预测股票方面的作用和效果，以及它们对整体模型性能的贡献。

#### 结果

![image-20230710103759604](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710103759604.png)

与仅使用历史价格的ARIMA相比，TECHNICALANALYST在这个任务中显示出明显的优势。我们认为有两个主要原因：（1）TECHNICALANALYST从训练数据中学习，并融入了更灵活的非线性；（2）我们的测试集包含大量股票，而ARIMA对于特殊的序列平稳性更敏感。值得注意的是，FUNDAMENTALANALYST的性能异常竞争力强，仅在MCC上比HEDGEFUNDANALYST少0.009092。FUNDAMENTALANALYST和TECHNICALANALYST的性能证实了推文和历史价格在股票运动预测中的积极影响。作为这两种市场信息的有效集成，HEDGEFUNDANALYST获得了更好的性能。

与DISCRIMINATIVEANALYST相比，HEDGEFUNDANALYST的性能改进并不是通过扩大网络规模实现的，这表明明确建模潜在驱动因素的市场状态的确有助于股票运动预测。与INDEPENDENTANALYST的比较还显示了利用时间辅助信息捕捉预测之间的时间依赖性的有效性。然而，时间辅助的影响更为复杂，将在下一节中进行进一步分析。

#### 时间辅助信息的影响

我们对时间辅助如何影响模型性能进行了详细讨论。正如在公式（28）中介绍的那样，时间辅助权重α控制了目标层面时间辅助对我们模型整体的影响。图4展示了HEDGEFUNDANALYST和DISCRIMINATIVEANALYST的性能如何随α的变化而波动。

![image-20230710104419404](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710104419404.png)

如图4所示，受时间辅助的增强影响，HEDGEFUNDANALYST在α为0.5时接近最佳性能，而DISCRIMINATIVEANALYST在α为0.7时达到最大性能。事实上，目标层面的辅助可以被视为一种去噪的正则化器：对于具有特定运动作为主要目标的样本，滞后期的市场信息可能是异质的，例如受到负面消息的影响，早期的推文可能是负面的，但由于及时的危机管理，变为正面的。如果没有时间辅助任务，模型只会针对上涨运动的主要目标在早期的交易日中识别正面信号，这很可能导致纯噪声。在这种情况下，时间辅助任务有助于根据它们各自对齐的辅助运动过滤滞后期的市场信息。此外，从训练变分模型的角度来看，时间辅助有助于HEDGEFUNDANALYST将更有用的信息编码到潜在驱动因子Z中，这与近期在变分自编码器（VAE）中的研究结果是一致的（Semeniuta等人，2017）。与包含动态正则化的KL项的HEDGEFUNDANALYST相比，DISCRIMINATIVEANALYST需要更强的正则化效果，需要更大的α来达到最佳性能。

由于y∗也参与通过时间注意力生成yT，调整α在关注主要目标和去噪泛化之间达到平衡。因此，正如图4所示，我们的模型并不是线性受益于引入时间辅助。事实上，两个模型在性能变化方面遵循相似的模式：曲线首先随着α的增加而下降，除了DISCRIMINATIVEANALYST的MCC曲线在α为0.3时暂时上升。之后，曲线突然上升到最大值，然后继续下降直到α = 1。尽管增加α的起始阶段甚至导致性能下降，但当辅助效果被适当引入时，两个模型最终获得的结果比没有辅助效果参与的模型（如INDEPENDENTANALYST）更好。

### 结论

我们通过引入StockNet，一个用于基于社交媒体数据进行股票运动预测的神经网络架构，展示了深度生成式方法在这一任务中的有效性。我们在一个新的综合数据集上对我们的模型进行了测试，并展示它在性能上优于强基线模型，包括之前工作的实现。我们的综合数据集已公开发布在https://github.com/yumoxu/stocknet-dataset上。



### 问题：

图3什么意思？

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230710095350844.png" alt="image-20230710095350844" style="zoom:67%;" />

什么是似然项？

非交易日解决方法？
